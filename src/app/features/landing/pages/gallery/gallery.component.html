<div class="message-board">
    <h1 class="title" [style.viewTransitionName]="'title'">Messages and moments <br /> that lift us up</h1>
    <p class="subtitle">
        Explore heartfelt cards, creative art, and inspiring words from people who care.
        Every message is a reminder that you’re never alone on your journey.
    </p>

    <div class="tabs">
        @for (tab of tabs; track tab) {
            <button
                [class.active]="tab === activeTab()"
                (click)="selectTab(tab)">
                {{ tab }}
            </button>
        }
    </div>

    <div class="filters-panel">
        <div class="row">
            <w-autocomplete
                [isAllInfo]="true"
                placeholder="Search by location, credit to, or tag"
                emptyHint="Type to search"
                (select)="applyTextFilter($event)"
                (inputChange)="null" />

            <button class="clear-btn" type="button" (click)="clearAllFilters()">Clear</button>
        

            <!-- <input 
                type="search" placeholder="Note..."
                [value]="filters().description || ''"
                (input)="applyTextFilter('description', ($any($event.target).value))" />
      
            <w-autocomplete
                field="creditTo"
                placeholder="Credit to…"
                [initial]="filters().creditTo || ''"
                emptyHint="Type to search credits"
                (input)="applyTextFilter('creditTo', ($any($event.target).value))" /> -->
                
          <!-- <input type="search" placeholder="Credit to…"
                 [value]="filters().creditTo || ''"
                 (change)="applyTextFilter('creditTo', ($any($event.target).value))" /> -->
      
          <!-- <div class="tags-input">
            <input type="text" placeholder="Add tag and press Enter"
                   (keydown.enter)="addTag(($any($event.target).value)); $any($event.target).value='';" />
          </div> -->
      
          <!-- <div class="mode-toggle" role="group" aria-label="Tags matching mode">
            <button type="button"
                    [class.active]="(filters().tagsMode||'any')==='any'"
                    (click)="setQueryPatch({ tagsMode: 'any' })">OR (any)</button>
            <button type="button"
                    [class.active]="(filters().tagsMode||'any')==='all'"
                    (click)="setQueryPatch({ tagsMode: 'all' })">AND (all)</button>
          </div> -->
        </div>
      
        @if (hasAnyFilter()) {
            <div class="chips">
              @if (filters().location) {
                <button class="chip" (click)="applyTextFilter({ key: 'location', value: ''})">
                  Location: {{ filters().location }} <span class="x">×</span>
                </button>
              }
              <!-- @if (filters().description) {
                <button class="chip" (click)="applyTextFilter('description','')">
                  Description: {{ filters().description }} <span class="x">×</span>
                </button>
              } -->
              @if (filters().creditTo) {
                <button class="chip" (click)="applyTextFilter({ key: 'creditTo', value: '' })">
                  Credit: {{ filters().creditTo }} <span class="x">×</span>
                </button>
              }
              @if (activeTab() !== 'All') {
                <!-- @for (t of filters().tags; track t) { -->
                  <button class="chip" (click)="applyTextFilter({ key: 'tab', value: 'All'})">
                    #{{ filters().tab }} <span class="x">×</span>
                  </button>
                <!-- } -->
              }
              <!-- @if (filters().tagsMode) {
                <button class="chip" (click)="toggleTagsMode()">
                  Mode: {{ (filters().tagsMode||'any').toUpperCase() }} <span class="x">⇆</span>
                </button>
              } -->
            </div>
        }

    </div>

    @if (!isLoading() && cards().length === 0) {
        <div class="empty-state" aria-live="polite">
            <div class="illus" aria-hidden="true">
                <svg viewBox="0 0 64 64" width="68" height="68">
                    <defs>
                        <linearGradient id="glow" x1="0" x2="1">
                            <stop offset="0" stop-color="#cfd4da" />
                            <stop offset="1" stop-color="#e9ecef" />
                        </linearGradient>
                    </defs>
                    <circle cx="28" cy="28" r="14" fill="url(#glow)" />
                    <circle cx="28" cy="28" r="12" fill="none" stroke="#adb5bd" stroke-width="2" />
                    <rect x="38" y="38" width="18" height="6" rx="3" fill="#ced4da" transform="rotate(48 40 40)"></rect>
                </svg>
            </div>
    
            <h3>No matches yet</h3>
            <p>Try adjusting filters or change the tag logic.</p>
    
            <div class="actions">
                <button class="btn primary" type="button" (click)="clearAllFilters()">Reset filters</button>
            </div>
    
            @if (hasAnyFilter()) {
                <div class="tips">
                    @if (filters().location) {
                        <span class="tip" (click)="applyTextFilter({ key: 'location', value: ''})">Remove location</span>
                    }
                    <!-- @if (filters().description) {
                        <span class="tip" (click)="applyTextFilter({ key: 'description', value: ''})">Remove description</span>
                    } -->
                    @if (filters().creditTo) {
                        <span class="tip" (click)="applyTextFilter({ key: 'creditTo', value: ''})">Remove credit</span>
                    }
                    @if (filters().tab) {
                        <span class="tip" (click)="applyTextFilter({ key: 'tab', value: 'All'})">
                            Remove #{{ filters().tab }}
                        </span>
                    }
                </div>
            }
        </div>
    }

    @if (!isLoading()) {
        <div class="card-grid">
            @for (card of cards(); track card; let i = $index) {
                <div
                    class="card"
                    [style]="'--i: 0.02s'"
                    (mouseenter)="mouseEnterCard(card.id)">
                    <div class="card-image-wrap" (click)="openVoicePage(card.id)" >
                        <img
                            class="card-image"
                            [src]="card.img"
                            alt="card image" 
                            [style.viewTransitionName]="
                                activeImageId() === card.id ? computedViewImg(card.id) : 'none'
                            "/>
                    </div>
                    <div class="card-content">
                        <div 
                            class="wrap-category" 
                            [style.viewTransitionName]="
                                activeImageId() === card.id ? computedViewTag(card.id) : 'none'
                            ">
                            @if (card.category) {
                                <span
                                    class="category"
                                    (click)="selectTab(card.category)">
                                    {{ card.category }}
                                </span>
                            }
                            @for (tag of card.what; track tag) {
                                <span 
                                    class="category"
                                    (click)="selectTab(tag)">
                                    {{ tag }}
                                </span>
                            }
                            @for (tag of card.express; track tag) {
                                <span 
                                    class="category"
                                    (click)="selectTab(tag)">
                                    {{ tag }}
                                </span>
                            }
                        </div>
                        <h2
                            (click)="openVoicePage(card.id)"
                            class="card-title">
                            {{ card.location }}
                        </h2>
                    </div>
                </div>
            }
        </div>

        @if (isFetchingMore()) {
            <div class="infinite-loader">
              <div class="loader-wave">
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
              </div>
            </div>
        }
      
        @if (hasMore()) {
            <div #sentinel class="sentinel" aria-hidden="true"></div>
        }
    } @else {
        <div class="content">
            <div class="loader-wave">
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
            </div>
        </div>
    }
</div>
