<div class="message-board">
    <h1 class="title">Messages and moments <br /> that lift us up</h1>
    <p class="subtitle">
        Explore heartfelt cards, creative art, and inspiring words from people who care.
        Every message is a reminder that you’re never alone on your journey.
    </p>

    <div class="tabs">
        @for (tab of tabs; track tab) {
            <button
                [class.active]="tab === activeTab()"
                (click)="selectTab(tab)">
                {{ tab }}
            </button>
        }
    </div>

    <div class="filters-panel">
        <div class="row">
          <input type="search" placeholder="Title (location)…"
                 [value]="filters().title || ''"
                 (change)="applyTextFilter('title', ($any($event.target).value))" />
      
          <input type="search" placeholder="Description (note)…"
                 [value]="filters().description || ''"
                 (change)="applyTextFilter('description', ($any($event.target).value))" />
      
          <input type="search" placeholder="Credit to…"
                 [value]="filters().creditTo || ''"
                 (change)="applyTextFilter('creditTo', ($any($event.target).value))" />
      
          <!-- <div class="tags-input">
            <input type="text" placeholder="Add tag and press Enter"
                   (keydown.enter)="addTag(($any($event.target).value)); $any($event.target).value='';" />
          </div> -->
      
          <!-- <div class="mode-toggle" role="group" aria-label="Tags matching mode">
            <button type="button"
                    [class.active]="(filters().tagsMode||'any')==='any'"
                    (click)="setQueryPatch({ tagsMode: 'any' })">OR (any)</button>
            <button type="button"
                    [class.active]="(filters().tagsMode||'any')==='all'"
                    (click)="setQueryPatch({ tagsMode: 'all' })">AND (all)</button>
          </div> -->
      
          <button class="clear-btn" type="button" (click)="clearAllFilters()">Clear</button>
        </div>
      
        <div class="chips" *ngIf="hasAnyFilter()">
          @if (filters().title) {
            <button class="chip" (click)="applyTextFilter('title','')">
              Title: {{ filters().title }} <span class="x">×</span>
            </button>
          }
          @if (filters().description) {
            <button class="chip" (click)="applyTextFilter('description','')">
              Description: {{ filters().description }} <span class="x">×</span>
            </button>
          }
          @if (filters().creditTo) {
            <button class="chip" (click)="applyTextFilter('creditTo','')">
              Credit: {{ filters().creditTo }} <span class="x">×</span>
            </button>
          }
          @if (filters().tags?.length) {
            @for (t of filters().tags; track t) {
              <button class="chip" (click)="removeTag(t)">
                #{{ t }} <span class="x">×</span>
              </button>
            }
          }
          @if (filters().tagsMode) {
            <button class="chip" (click)="toggleTagsMode()">
              Mode: {{ (filters().tagsMode||'any').toUpperCase() }} <span class="x">⇆</span>
            </button>
          }
        </div>
    </div>

    @if (!isLoading()) {
        <div class="card-grid">
            @for (card of cards(); track card; let i = $index) {
                <div
                    class="card"
                    [style]="'--i: ' + ((i - (pageSize * (page() - 1))) * 0.10) + 's'">
                    <div class="card-image-wrap" (click)="openVoicePage(card.id)">
                        <img
                            class="card-image"
                            [src]="card.img"
                            alt="card image" />
                    </div>
                    <div class="card-content">
                        <div class="wrap-category">
                            @if (card.category) {
                                <span
                                    class="category"
                                    (click)="selectTab(card.category)">
                                    {{ card.category }}
                                </span>
                            }
                            @for (tag of card.what; track tag) {
                                <span 
                                    class="category"
                                    (click)="selectTab(tag)">
                                    {{ tag }}
                                </span>
                            }
                            @for (tag of card.express; track tag) {
                                <span 
                                    class="category"
                                    (click)="selectTab(tag)">
                                    {{ tag }}
                                </span>
                            }
                        </div>
                        <h2 class="card-title" (click)="openVoicePage(card.id)">{{ card.location }}</h2>
                    </div>
                </div>
            }
        </div>

        @if (isFetchingMore()) {
            <div class="infinite-loader">
              <div class="loader-wave">
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
              </div>
            </div>
        }
      
        @if (hasMore()) {
            <div #sentinel class="sentinel" aria-hidden="true"></div>
        }
    } @else {
        <div class="content">
            <div class="loader-wave">
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
                <div class="wave-dot"></div>
            </div>
        </div>
    }
</div>
