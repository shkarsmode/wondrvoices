<div class="request-support">
    <div class="header-section">
        <div class="icon-circle">
            <span class="material-symbols-outlined">volunteer_activism</span>
        </div>
        <h1>Request Support From Our Community</h1>
        <p class="subtitle">
            If you or a loved one is facing a difficult journey, you deserve support.
        </p>

        <!-- Progress bar -->
        <div class="progress-container">
            <div class="progress-info">
                <span>Step {{ currentStep() }} of {{ totalSteps }}</span>
                <span class="time-remaining" *ngIf="timeRemaining() > 0">
                    <span class="material-symbols-outlined icon">schedule</span>
                    ~{{ timeRemaining() }} min remaining
                </span>
                <span class="complete-text" *ngIf="timeRemaining() === 0">
                    <span class="material-symbols-outlined icon">check_circle</span>
                    Complete!
                </span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="progress()"></div>
            </div>
            <div class="progress-steps">
                <div 
                    *ngFor="let step of [1, 2, 3, 4, 5, 6]" 
                    class="step-indicator"
                    [class.completed]="currentStep() > step"
                    [class.active]="currentStep() === step">
                    <div class="step-circle">
                        <span class="material-symbols-outlined" *ngIf="currentStep() > step">check</span>
                        <span *ngIf="currentStep() <= step">{{ step }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 1: Tell Us Your Story -->
    <div class="step-content fade-in" *ngIf="currentStep() === 1">
        <div class="card">
            <h2>Tell Us Your Story</h2>
            <p class="step-description">Let's start with who this journey is for.</p>

            <div class="form-group">
                <label class="question-label">Whose journey is this? <span class="required">*</span></label>
                <div class="options-grid">
                    <button 
                        *ngFor="let journey of journeyTypes"
                        type="button"
                        class="option-btn"
                        [class.selected]="selectedJourneyType() === journey.id"
                        (click)="selectJourneyType(journey.id)">
                        <span class="material-symbols-outlined">person</span>
                        <span>{{ journey.label }}</span>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="question-label">What are you going through? <span class="required">*</span></label>
                <div class="options-grid">
                    <button 
                        *ngFor="let condition of conditionOptions"
                        type="button"
                        class="option-btn"
                        [class.selected]="selectedCondition() === condition"
                        (click)="selectCondition(condition)">
                        {{ condition }}
                    </button>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-continue" (click)="nextStep()">
                    Continue <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 2: Where in the Journey -->
    <div class="step-content fade-in" *ngIf="currentStep() === 2">
        <div class="card">
            <h2>Where in the Journey?</h2>
            <p class="step-description">This helps us match your moment with the right kind of support.</p>

            <div class="form-group">
                <label class="question-label">Select the current moment <span class="required">*</span></label>
                <div class="options-grid">
                    <button 
                        *ngFor="let stage of journeyStageOptions"
                        type="button"
                        class="option-btn"
                        [class.selected]="selectedJourneyStage() === stage.value"
                        (click)="selectJourneyStage(stage.value)">
                        {{ stage.label }}
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="question-label">Additional context (Optional)</label>
                <p class="help-text">Select any that apply to help us match better support.</p>
                <div class="tag-group">
                    <button 
                        *ngFor="let tag of additionalContextOptions"
                        type="button"
                        class="tag-btn"
                        [class.selected]="isContextTagSelected(tag)"
                        (click)="toggleContextTag(tag)">
                        {{ tag }}
                    </button>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="previousStep()">
                    Back
                </button>
                <button type="button" class="btn-continue" (click)="nextStep()">
                    Continue <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 3: What Brings Comfort -->
    <div class="step-content fade-in" *ngIf="currentStep() === 3">
        <div class="card">
            <h2>What Brings Comfort?</h2>
            <p class="step-description">Select the types of messages that would brighten your day.</p>

            <div class="form-group">
                <label class="question-label">Choose comfort zones <span class="required">*</span></label>
                <div class="comfort-zones-grid">
                    <button 
                        *ngFor="let zone of comfortZones"
                        type="button"
                        class="comfort-zone-btn"
                        [class.selected]="isZoneSelected(zone.id)"
                        (click)="toggleComfortZone(zone.id)">
                        <span class="material-symbols-outlined zone-icon">{{ zone.icon }}</span>
                        <span class="zone-label">{{ zone.label }}</span>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>Anything else to share? (Optional)</label>
                <textarea 
                    #additionalNoteInput
                    placeholder="Share anything else that might help us connect with the right messages..."
                    class="form-textarea"
                    rows="4"
                    (input)="step3Form.patchValue({ additionalNote: additionalNoteInput.value })"></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="previousStep()">
                    Back
                </button>
                <button type="button" class="btn-continue" (click)="nextStep()">
                    Continue <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 4: Just a Few Details -->
    <div class="step-content fade-in" *ngIf="currentStep() === 4">
        <div class="card">
            <h2>Just a Few Details</h2>
            <p class="step-description">Help supporters personalize their messages.</p>

            <form [formGroup]="step4Form">
                <div class="form-group">
                    <label>Your First Name (Optional)</label>
                    <input 
                        type="text" 
                        formControlName="firstName"
                        placeholder="e.g., Sarah"
                        class="form-input">
                </div>

                <div class="form-group">
                    <label>Email for Verification <span class="required">*</span></label>
                    <input 
                        type="email" 
                        formControlName="email"
                        placeholder="your@email.com"
                        class="form-input">
                    <small class="help-text">We'll send a verification code. Never shown publicly.</small>
                </div>

                <div class="form-group">
                    <label>Your Age <span class="required">*</span></label>
                    <input 
                        type="number" 
                        formControlName="age"
                        placeholder="e.g., 42"
                        class="form-input">
                </div>

                <div class="form-group">
                    <label>Your Gender (Optional)</label>
                    <div class="gender-buttons">
                        <button 
                            type="button"
                            class="gender-btn"
                            [class.selected]="step4Form.value.gender === 'male'"
                            (click)="step4Form.patchValue({ gender: 'male' })">
                            Male
                        </button>
                        <button 
                            type="button"
                            class="gender-btn"
                            [class.selected]="step4Form.value.gender === 'female'"
                            (click)="step4Form.patchValue({ gender: 'female' })">
                            Female
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Where do you live? (City, State) <span class="required">*</span></label>
                    <input 
                        type="text" 
                        formControlName="location"
                        placeholder="e.g., Seattle, WA"
                        class="form-input">
                    <small class="help-text">Helps the community send regionally relevant support.</small>
                </div>
            </form>

            <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="previousStep()">
                    Back
                </button>
                <button type="button" class="btn-continue" (click)="nextStep()" [disabled]="isSubmitting()">
                    Verify Email <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 5: Email Verification -->
    <div class="step-content fade-in" *ngIf="currentStep() === 5">
        <div class="card">
            <div class="verification-icon">
                <span class="material-symbols-outlined">shield</span>
            </div>
            <h2>Verify Your Email</h2>
            <p class="step-description">To prevent spam, please verify your email address.</p>

            <div class="email-display">
                <span class="material-symbols-outlined">mail</span>
                <span class="email">{{ step4Form.value.email }}</span>
                <a href="javascript:void(0)" class="change-link" (click)="previousStep()">Change</a>
            </div>

            <div class="form-group">
                <label>Enter the 6-digit code sent to your email:</label>
                <div class="code-inputs">
                    <input 
                        #codeInput
                        *ngFor="let digit of [0,1,2,3,4,5]"
                        type="text" 
                        inputmode="numeric"
                        maxlength="1"
                        class="code-input"
                        placeholder="0"
                        autocomplete="off"
                        [value]="verificationCode()[digit] || ''"
                        (input)="onCodeInput(digit, $event)"
                        (keydown)="onCodeKeyDown(digit, $event)"
                        (paste)="onCodePaste($event)">
                </div>
            </div>

            <div class="demo-info" *ngIf="demoVerificationCode()">
                <strong>Demo Mode:</strong> Enter any 6 digits to proceed (e.g., 123456)
            </div>

            <div class="resend-section">
                <span>Didn't receive a code?</span>
                <a href="javascript:void(0)" (click)="resendCode()" class="resend-link">Resend code</a>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="previousStep()">
                    Back
                </button>
                <button type="button" class="btn-continue" (click)="verifyEmailCode()" [disabled]="isSubmitting()">
                    Submit <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 6: Success -->
    <div class="step-content fade-in" *ngIf="currentStep() === 6">
        <div class="card success-card">
            <div class="success-icon">
                <span class="material-symbols-outlined">check_circle</span>
            </div>
            <h2>Journey Shared Successfully!</h2>
            <p class="step-description">Your unique Journey ID is:</p>

            <div class="journey-id">
                <strong>{{ requestId() }}</strong>
                <p>Save this ID to track your personalized notes</p>
            </div>

            <div class="what-happens">
                <h3>What happens next?</h3>
                <ul>
                    <li><span class="material-symbols-outlined">check</span> Our caring community will create personalized notes</li>
                    <li><span class="material-symbols-outlined">check</span> Notes will be matched to the comfort zones selected</li>
                    <li><span class="material-symbols-outlined">check</span> You'll receive notifications when new notes arrive</li>
                </ul>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-continue" (click)="viewFeed()">
                    View Feed
                </button>
                <button type="button" class="btn-secondary" (click)="backToHome()">
                    Back to Home
                </button>
            </div>
        </div>
    </div>

    <!-- Toast notification (for demo) -->
    <div class="toast" *ngIf="demoVerificationCode() && currentStep() === 5" [@fadeInOut]>
        <div class="toast-content">
            <strong>Verification code sent!</strong>
            <p>A 6-digit code has been sent to {{ step4Form.value.email }}</p>
        </div>
    </div>
</div>
