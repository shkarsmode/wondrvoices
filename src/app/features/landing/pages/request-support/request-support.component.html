<div class="request-support">
    <div class="header-section">
        <div class="icon-circle healing">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 19c-1.8-1.4-3-3-3.2-4.8a3 3 0 0 1 2.7-3.2 2.8 2.8 0 0 1 2.1.8"/>
                <path d="M9.2 12c.7-.7 1.7-1 2.8-.8a3 3 0 0 1 2.7 3.2c-.2 1.8-1.4 3.4-3.2 4.8"/>
                <path d="M4.9 4.9c3.9-3.9 10.3-3.9 14.2 0 3.9 3.9 3.9 10.3 0 14.2"/>
                <path d="M19.1 4.9c3.9 3.9 3.9 10.3 0 14.2-3.9 3.9-10.3 3.9-14.2 0"/>
            </svg>
        </div>
        <h1>Share Your Journey</h1>
        <p class="subtitle">
            Sometimes the bravest thing we can do is let others show up for us.<br>
            By sharing your story, you give the world a chance to wrap its arms around you.
        </p>

        <!-- Progress bar -->
        <div class="progress-container">
            <div class="progress-info">
                <span>Step {{ currentStep() }} of {{ totalSteps }}</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="progress()"></div>
            </div>
        </div>
    </div>

    <!-- Step 1: Tell Us Your Story -->
    <div class="step-content fade-in" *ngIf="currentStep() === 1">
        <div class="card">
            <h2>What are you or your loved one facing?</h2>

            <!-- Question 1: What are you or your loved one facing? -->
            <div class="form-group">
                <div class="options-grid situation-grid">
                    <button 
                        *ngFor="let situation of situationOptions"
                        type="button"
                        class="option-btn situation-btn"
                        [class.selected]="selectedSituation() === situation.id"
                        (click)="selectSituation(situation.id)">
                        {{ situation.label }}
                    </button>
                </div>
            </div>

            <!-- Question 2: Who is going through this? (shown after situation selected, except for grief) -->
            <div class="form-group separator" *ngIf="selectedSituation() && !isGriefSituation()">
                <label class="question-label">Who is going through this? <span class="required">*</span></label>
                <div class="options-grid support-recipient-grid">
                    <button 
                        *ngFor="let recipient of supportRecipientOptions"
                        type="button"
                        class="option-btn recipient-btn"
                        [class.selected]="whoNeedsSupport() === recipient.id"
                        (click)="selectWhoNeedsSupport(recipient.id)">
                        <span class="material-symbols-outlined">{{ recipient.icon }}</span>
                        <span>{{ recipient.label }}</span>
                    </button>
                </div>
            </div>

            <!-- Relationship question (shown for "A Loved One" or grief situations) -->
            <div class="form-group separator" *ngIf="(whoNeedsSupport() === 'someone-i-care-for' && !isGriefSituation()) || isGriefSituation()">
                <label class="question-label">
                    {{ isGriefSituation() ? 'What was your relationship to them?' : 'What is your relationship to them?' }}
                    <span class="required">*</span>
                </label>
                <div class="options-grid relationship-grid">
                    <button 
                        *ngFor="let relationship of caregiverRelationshipOptions"
                        type="button"
                        class="option-btn relationship-btn"
                        [class.selected]="caregiverRelationship() === relationship.id"
                        (click)="selectCaregiverRelationship(relationship.id)">
                        {{ relationship.label }}
                    </button>
                </div>
            </div>

            <div class="form-actions single-btn">
                <button type="button" class="btn-continue" [class.disabled]="!canContinueStep1()" (click)="nextStep()">
                    Continue <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 2: Where in the Journey -->
    <div class="step-content fade-in" *ngIf="currentStep() === 2">
        <div class="card">
            <h2>Where in the Journey?</h2>
            <p class="step-description">This helps us match your moment with the right kind of support.</p>

            <div class="form-group">
                <label class="question-label">Select the current moment <span class="required">*</span></label>
                <div class="options-grid journey-grid">
                    <button 
                        *ngFor="let stage of getJourneyStageOptions()"
                        type="button"
                        class="option-btn journey-btn"
                        [class.selected]="selectedJourneyStage() === stage.value"
                        (click)="selectJourneyStage(stage.value)">
                        {{ stage.label }}
                    </button>
                </div>
            </div>

            <div class="form-group" *ngIf="getContextTags().length > 0">
                <label class="question-label">Additional context (Optional)</label>
                <p class="help-text">Select any that apply to help us match better support.</p>
                <div class="tag-group">
                    <button 
                        *ngFor="let tag of getContextTags()"
                        type="button"
                        class="tag-btn"
                        [class.selected]="isContextTagSelected(tag)"
                        (click)="toggleContextTag(tag)">
                        {{ tag }}
                    </button>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="previousStep()">
                    Back
                </button>
                <button type="button" class="btn-continue" [class.disabled]="!selectedJourneyStage()" (click)="nextStep()">
                    Continue <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 3: What Brings Comfort -->
    <div class="step-content fade-in" *ngIf="currentStep() === 3">
        <div class="card">
            <h2>What Brings Comfort?</h2>
            <p class="step-description">Select the types of messages that would brighten your day.</p>

            <div class="form-group">
                <label class="question-label">Choose comfort zones <span class="required">*</span></label>
                <div class="comfort-zones-grid">
                    <button 
                        *ngFor="let zone of comfortZones"
                        type="button"
                        class="comfort-zone-btn"
                        [class.selected]="isZoneSelected(zone.id)"
                        (click)="toggleComfortZone(zone.id)">
                        <span class="material-symbols-outlined zone-icon">{{ zone.icon }}</span>
                        <span class="zone-label">{{ zone.label }}</span>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>Anything else to share? (Optional)</label>
                <textarea 
                    #additionalNoteInput
                    placeholder="Share anything else that might help us connect with the right messages..."
                    class="form-textarea"
                    rows="4"
                    (input)="step3Form.patchValue({ additionalNote: additionalNoteInput.value })"></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="previousStep()">
                    Back
                </button>
                <button type="button" class="btn-continue" [class.disabled]="selectedComfortZones().length === 0" (click)="nextStep()">
                    Continue <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 4: Just a Few Details -->
    <div class="step-content fade-in" *ngIf="currentStep() === 4">
        <div class="card">
            <h2>Just a Few Details</h2>
            <p class="step-description">Help supporters personalize their messages.</p>

            <form [formGroup]="step4Form">
                <div class="form-group">
                    <label>{{ getNameLabel() }} (Optional)</label>
                    <input 
                        type="text" 
                        formControlName="firstName"
                        placeholder="e.g., Sarah"
                        class="form-input">
                    <div class="anonymous-option">
                        <input type="checkbox" id="postAnonymously" [checked]="isAnonymous()" (change)="toggleAnonymous()">
                        <label for="postAnonymously">Post anonymously</label>
                        <span class="info-icon" title="Your name won't be shown publicly">
                            <span class="material-symbols-outlined">info</span>
                        </span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Email for Verification <span class="required">*</span></label>
                    <input 
                        type="email" 
                        formControlName="email"
                        placeholder="your&#64;email.com"
                        class="form-input">
                    <small class="help-text">We'll send a verification code. Never shown publicly.</small>
                </div>

                <div class="form-group">
                    <label>{{ getAgeLabel() }} <span class="required">*</span></label>
                    <input 
                        type="number" 
                        formControlName="age"
                        placeholder="e.g., 42"
                        class="form-input">
                </div>

                <div class="form-group">
                    <label>{{ getGenderLabel() }} (Optional)</label>
                    <div class="gender-buttons">
                        <button 
                            type="button"
                            class="gender-btn"
                            [class.selected]="step4Form.value.gender === 'male'"
                            (click)="step4Form.patchValue({ gender: 'male' })">
                            Male
                        </button>
                        <button 
                            type="button"
                            class="gender-btn"
                            [class.selected]="step4Form.value.gender === 'female'"
                            (click)="step4Form.patchValue({ gender: 'female' })">
                            Female
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>{{ getLocationLabel() }} (City, State) <span class="required">*</span></label>
                    <input 
                        type="text" 
                        formControlName="location"
                        placeholder="e.g., Seattle, WA"
                        class="form-input">
                    <small class="help-text">Helps the community send regionally relevant support.</small>
                </div>
            </form>

            <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="previousStep()">
                    Back
                </button>
                <button type="button" class="btn-continue" (click)="nextStep()" [disabled]="isSubmitting()">
                    Verify Email <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 5: Email Verification -->
    <div class="step-content" *ngIf="currentStep() === 5">
        <div class="card verification-card">
            <div class="verification-icon">
                <span class="material-symbols-outlined">shield</span>
            </div>
            <h2>Verify Your Email</h2>
            <p class="step-description">To prevent spam, please verify your email address.</p>

            <div class="email-display">
                <span class="material-symbols-outlined">mail</span>
                <span class="email-text">{{ step4Form.value.email }}</span>
                <a href="javascript:void(0)" class="change-link" (click)="previousStep()">Change</a>
            </div>

            <div class="form-group">
                <label>Enter the 6-digit code sent to your email:</label>
                <div class="code-inputs">
                    <input 
                        #codeInput
                        *ngFor="let digit of [0,1,2,3,4,5]"
                        type="text" 
                        inputmode="numeric"
                        maxlength="1"
                        class="code-input"
                        placeholder="0"
                        autocomplete="off"
                        [value]="verificationCode()[digit] || ''"
                        (input)="onCodeInput(digit, $event)"
                        (keydown)="onCodeKeyDown(digit, $event)"
                        (paste)="onCodePaste($event)">
                </div>
            </div>

            <div class="demo-info" *ngIf="demoVerificationCode()">
                <strong>Demo Mode:</strong> Enter any 6 digits to proceed (e.g., 123456)
            </div>

            <div class="resend-section">
                <span>Didn't receive a code?</span>
                <a href="javascript:void(0)" (click)="resendCode()" class="resend-link">Resend code</a>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="previousStep()">
                    Back
                </button>
                <button type="button" class="btn-continue" (click)="nextStep()" [disabled]="isSubmitting()">
                    <span *ngIf="!isSubmitting()">Submit</span>
                    <span *ngIf="isSubmitting()" class="spinner"></span>
                    <span class="material-symbols-outlined" *ngIf="!isSubmitting()">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Step 6: Success -->
    <div class="step-content" *ngIf="currentStep() === 6">
        <div class="card success-card">
            <div class="success-icon">
                <span class="material-symbols-outlined">check_circle</span>
            </div>
            <h2>Journey Shared Successfully!</h2>
            <p class="step-description">Your unique Journey ID is:</p>

            <div class="journey-id">
                <strong>{{ requestId() }}</strong>
                <p>Save this ID to track your personalized notes</p>
            </div>

            <div class="what-happens">
                <h3>What happens next?</h3>
                <ul>
                    <li><span class="material-symbols-outlined">check</span> Our caring community will create personalized notes</li>
                    <li><span class="material-symbols-outlined">check</span> Notes will be matched to the comfort zones selected</li>
                    <li><span class="material-symbols-outlined">check</span> You'll receive notifications when new notes arrive</li>
                </ul>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-continue" (click)="viewFeed()">
                    View Feed
                </button>
                <button type="button" class="btn-secondary" (click)="backToHome()">
                    Back to Home
                </button>
            </div>
        </div>
    </div>
</div>
