<div class="request-support">
    <div class="header-section">
        <div class="icon-circle">
            <span class="material-symbols-outlined">volunteer_activism</span>
        </div>
        <h1>Request Support From Our Community</h1>
        <p class="subtitle">
            If you or a loved one is facing cancer, a rare disease, or other serious illness, you deserve support.
        </p>
        <p class="privacy-note">Your request stays anonymous. We just need to verify your email/phone to prevent spam.</p>

        <!-- Progress bar -->
        <div class="progress-container">
            <div class="progress-info">
                <span>Step {{ currentStep() }} of {{ totalSteps }}</span>
                <span class="time-remaining" *ngIf="timeRemaining() > 0">
                    <span class="material-symbols-outlined icon">schedule</span>
                    ~{{ timeRemaining() }} min remaining
                </span>
                <span class="complete-text" *ngIf="timeRemaining() === 0">
                    <span class="material-symbols-outlined icon">check_circle</span>
                    Complete!
                </span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="progress()"></div>
            </div>
            <div class="progress-steps">
                <div 
                    *ngFor="let step of [1, 2, 3, 4]" 
                    class="step-indicator"
                    [class.completed]="currentStep() > step"
                    [class.active]="currentStep() === step">
                    <div class="step-circle">
                        <span class="material-symbols-outlined" *ngIf="currentStep() > step">check</span>
                        <span *ngIf="currentStep() <= step">{{ step }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 1: Tell Us About You -->
    <div class="step-content" *ngIf="currentStep() === 1">
        <div class="card">
            <h2>Step 1: Tell Us About You</h2>

            <form [formGroup]="step1Form">
                <div class="form-group">
                    <label>First Name (Optional)</label>
                    <input 
                        type="text" 
                        formControlName="firstName"
                        placeholder="e.g., Sarah"
                        class="form-input">
                </div>

                <div class="form-group">
                    <label>Privacy Choice</label>
                    <div class="radio-group">
                        <label class="radio-option" [class.selected]="step1Form.value.privacyChoice === 'share'">
                            <input type="radio" formControlName="privacyChoice" value="share">
                            <div class="radio-content">
                                <strong>Share my first name</strong>
                                <p>People will see your first name, age, and location</p>
                            </div>
                        </label>
                        <label class="radio-option" [class.selected]="step1Form.value.privacyChoice === 'anonymous'">
                            <input type="radio" formControlName="privacyChoice" value="anonymous">
                            <div class="radio-content">
                                <strong>Stay completely anonymous</strong>
                                <p>People will only see your age and location (no name)</p>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="privacy-info">
                    Either way, your email/phone stays private and only your Request ID is used for tracking.
                </div>

                <div class="form-group">
                    <label>Email for Verification *</label>
                    <input 
                        type="email" 
                        formControlName="email"
                        placeholder="your@email.com"
                        class="form-input">
                    <small class="help-text">We'll send a verification code to confirm you're real. Never shown publicly.</small>
                </div>

                <div class="form-group">
                    <label>Age *</label>
                    <input 
                        type="number" 
                        formControlName="age"
                        placeholder="e.g., 42"
                        class="form-input">
                </div>

                <div class="form-group">
                    <label>Gender (Optional)</label>
                    <div class="gender-buttons">
                        <button 
                            type="button"
                            class="gender-btn"
                            [class.selected]="step1Form.value.gender === 'male'"
                            (click)="step1Form.patchValue({ gender: 'male' })">
                            Male
                        </button>
                        <button 
                            type="button"
                            class="gender-btn"
                            [class.selected]="step1Form.value.gender === 'female'"
                            (click)="step1Form.patchValue({ gender: 'female' })">
                            Female
                        </button>
                        <button 
                            type="button"
                            class="gender-btn"
                            [class.selected]="step1Form.value.gender === 'prefer-not-to-say'"
                            (click)="step1Form.patchValue({ gender: 'prefer-not-to-say' })">
                            Prefer not to say
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Your Location (City, State) *</label>
                    <input 
                        type="text" 
                        formControlName="location"
                        placeholder="e.g., Seattle, WA"
                        class="form-input">
                    <small class="help-text">Helps the community send regionally relevant support.</small>
                </div>

                <div class="form-group">
                    <label>What You're Facing *</label>
                    <select formControlName="diagnosis" class="form-select">
                        <option value="">Select your diagnosis or situation</option>
                        <option *ngFor="let option of diagnosisOptions" [value]="option">{{ option }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Where Are You in Your Journey? *</label>
                    <select formControlName="journeyStage" class="form-select">
                        <option value="">Select where you are right now</option>
                        <option *ngFor="let option of journeyStageOptions" [value]="option">{{ option }}</option>
                    </select>
                    <small class="help-text">This helps us match you with the right kind of support for this moment.</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-continue" (click)="nextStep()">
                        Continue to Comfort Zones →
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Step 2: Your Comfort Zones -->
    <div class="step-content" *ngIf="currentStep() === 2">
        <div class="card">
            <h2>Step 2: Your Comfort Zones</h2>
            <p class="step-description">
                <strong>What brings you joy? *</strong><br>
                Select the types of messages that would brighten your day. We'll match you with supporters who share your vibe.
            </p>

            <div class="comfort-zones-grid">
                <button 
                    *ngFor="let zone of comfortZones"
                    type="button"
                    class="comfort-zone-btn"
                    [class.selected]="isZoneSelected(zone.id)"
                    (click)="toggleComfortZone(zone.id)">
                    <span class="material-symbols-outlined zone-icon">{{ zone.icon }}</span>
                    <span class="zone-label">{{ zone.label }}</span>
                </button>
            </div>

            <form [formGroup]="step2Form">
                <div class="form-group">
                    <label>A Little More About You (Optional)</label>
                    <textarea 
                        formControlName="additionalNote"
                        placeholder="Share anything else that might help us connect you with the right messages..."
                        class="form-textarea"
                        rows="4"></textarea>
                </div>
            </form>

            <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="previousStep()">
                    Back
                </button>
                <button type="button" class="btn-continue" (click)="nextStep()" [disabled]="isSubmitting()">
                    {{ isSubmitting() ? 'Submitting...' : 'Generate My Request ID →' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Step 3: Verify Your Email -->
    <div class="step-content" *ngIf="currentStep() === 3">
        <div class="card verification-card">
            <div class="icon-circle-small">
                <span class="material-symbols-outlined">verified_user</span>
            </div>
            <h2>Verify Your Email</h2>
            <p class="step-description">
                To prevent spam and ensure real requests, please verify your email address.
            </p>

            <div class="email-display">
                <span class="material-symbols-outlined icon">mail</span>
                {{ step1Form.value.email }}
                <button type="button" class="change-btn" (click)="currentStep.set(1)">Change</button>
            </div>

            <p class="verification-instruction">Enter the 6-digit code sent to your email:</p>

            <div class="code-input-container">
                <input 
                    *ngFor="let digit of [0,1,2,3,4,5]; let i = index"
                    type="text"
                    maxlength="1"
                    class="code-input"
                    [value]="verificationCodeInput()[i]"
                    (input)="onCodeInput(i, $event)"
                    (keydown)="onCodeKeyDown(i, $event)">
            </div>

            <div class="resend-section">
                <p>Didn't receive a code? <button type="button" class="link-btn" (click)="resendCode()">Resend code</button></p>
            </div>

            <div class="demo-notice" *ngIf="demoVerificationCode()">
                <strong>Demo Mode:</strong> Enter any 6 digits to proceed (e.g., {{ demoVerificationCode() }})
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" (click)="previousStep()">
                    Back
                </button>
                <button type="button" class="btn-continue" (click)="nextStep()" [disabled]="isSubmitting()">
                    {{ isSubmitting() ? 'Verifying...' : 'Verify & Submit →' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Step 4: Success -->
    <div class="step-content" *ngIf="currentStep() === 4">
        <div class="card success-card">
            <div class="icon-circle-success">
                <span class="material-symbols-outlined">check_circle</span>
            </div>
            <h2>Request Submitted Successfully!</h2>
            <p class="success-message">Your unique Request ID is:</p>

            <div class="request-id-box">
                {{ requestId() }}
            </div>
            <p class="save-id-note">Save this ID to track your personalized messages</p>

            <div class="next-steps">
                <h3>What happens next?</h3>
                <ul>
                    <li><span class="material-symbols-outlined">check</span> Our caring community will create personalized messages for you</li>
                    <li><span class="material-symbols-outlined">check</span> Messages will be matched to your comfort zones</li>
                    <li><span class="material-symbols-outlined">check</span> You'll receive notifications when new messages arrive</li>
                </ul>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-primary" (click)="viewGallery()">
                    View Gallery
                </button>
                <button type="button" class="btn-secondary" (click)="backToHome()">
                    Back to Home
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast notification (for demo) -->
<div class="toast" *ngIf="demoVerificationCode() && currentStep() === 3">
    <div class="toast-content">
        <strong>Verification code sent!</strong>
        <p>A 6-digit code has been sent to {{ step1Form.value.email }}</p>
    </div>
</div>

<div class="toast success-toast" *ngIf="currentStep() === 4">
    <div class="toast-content">
        <strong>Verified successfully! ✓</strong>
        <p>Your request is now being processed.</p>
    </div>
</div>
