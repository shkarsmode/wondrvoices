<div class="request-page" *ngIf="!loading(); else loadingTpl">
    <div class="back-link">
        <a routerLink="/browse-requests">â† Back to Requests</a>
    </div>

    <div class="header-card" *ngIf="request() as req">
        <div class="badge">ğŸ’š</div>
        <div class="header-main">
            <div class="title-row">
                <h1>{{ getDisplayName() }}</h1>
                <span class="request-id">{{ req.id }}</span>
            </div>
            <div class="meta-row">
                <span>ğŸ‘¤ Age {{ req.age }}</span>
                <span>ğŸ“ {{ req.location }}</span>
                <span>ğŸ•’ {{ getTimeAgo(req.createdAt) }}</span>
            </div>
            <div class="hospital" *ngIf="req.hospital">{{ req.hospital }}</div>
            <div class="diagnosis-badge">{{ req.diagnosis }}</div>
            <p class="note">{{ req.additionalNote }}</p>
            <div class="tags">
                <span class="tag" *ngFor="let zone of req.comfortZones">
                    {{ getComfortZoneIcon(zone) }} {{ zone | titlecase }}
                </span>
            </div>
            <div class="stats">
                <span>â¤ï¸ {{ req.hearts || 0 }}</span>
                <span>â†—ï¸ {{ req.shares || 0 }}</span>
                <span>ğŸ’¬ {{ req.comments || 0 }}</span>
            </div>
        </div>
        <div class="cta">
            <button class="btn-secondary">Send Love</button>
        </div>
    </div>

    <div class="support-section" *ngIf="request() as req">
        <h2>Send your support:</h2>
        <div class="send-message-card">
            <div class="accordion">
                <div class="accordion-item" [class.open]="accordionOpen().message">
                    <button class="accordion-header" (click)="toggleAccordion('message')">
                        <span class="left">
                            <span class="icon">ğŸ’¬</span>
                            <span>Send a message now</span>
                        </span>
                        <span class="chevron" [class.rotated]="accordionOpen().message">âŒƒ</span>
                    </button>
                    <div class="accordion-body" *ngIf="accordionOpen().message">
                        <div class="send-row">
                            <div class="inputs">
                                <textarea rows="3" placeholder="Write your message of support for {{ getDisplayName() }}..."></textarea>
                                <div class="name-and-button">
                                    <input type="text" placeholder="Your name (optional)">
                                    <button class="btn-primary">Send Message</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item" [class.open]="accordionOpen().social">
                    <button class="accordion-header" (click)="toggleAccordion('social')">
                        <span class="left">
                            <span class="icon">ğŸ”—</span>
                            <span>Share via social media</span>
                        </span>
                        <span class="chevron" [class.rotated]="accordionOpen().social">âŒƒ</span>
                    </button>
                    <div class="accordion-body" *ngIf="accordionOpen().social">
                        <p class="muted">Post a video, photo, or message and tag <strong>@wondrvoices</strong> with <span class="pill">#{{ req.id }}</span></p>
                        <div class="social-row">
                            <span class="social">ğŸ“¸</span>
                            <span class="social">ğŸ“˜</span>
                            <span class="social">ğŸ¦</span>
                            <span class="social">â–¶ï¸</span>
                        </div>
                    </div>
                </div>

                <div class="accordion-item" [class.open]="accordionOpen().upload">
                    <button class="accordion-header" (click)="toggleAccordion('upload')">
                        <span class="left">
                            <span class="icon">ğŸ“</span>
                            <span>Upload handwritten notes or artwork</span>
                        </span>
                        <span class="chevron" [class.rotated]="accordionOpen().upload">âŒƒ</span>
                    </button>
                    <div class="accordion-body" *ngIf="accordionOpen().upload">
                        <p class="muted">Snap a photo of your handwritten note or artwork and upload it (feature placeholder).</p>
                    </div>
                </div>

                <div class="accordion-item" [class.open]="accordionOpen().mail">
                    <button class="accordion-header" (click)="toggleAccordion('mail')">
                        <span class="left">
                            <span class="icon">âœ‰ï¸</span>
                            <span>Send physical mail</span>
                        </span>
                        <span class="chevron" [class.rotated]="accordionOpen().mail">âŒƒ</span>
                    </button>
                    <div class="accordion-body" *ngIf="accordionOpen().mail">
                        <p class="muted">Send a physical card or letter to:</p>
                        <div class="mail-box">
                            <div class="mail-line"><strong>WondrVoices</strong> | {{ req.id }}</div>
                            <div class="mail-line">PO Box 40056, St. Pete, FL 33743</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="share-row">
                <a>ğŸ”— Share This Request</a>
            </div>
        </div>

        <div class="amplify-card">
            <div class="title">Help amplify this request</div>
            <p>Real support takes a community. Your contribution helps us connect more people with the care they need and keeps requests like this visible to potential supporters.</p>
            <button class="chip-btn">Chip In</button>
        </div>

        <div class="community">
            <h3>Community Support</h3>
            <p class="muted">{{ getSupportCount() }} messages</p>
            <div class="messages-grid">
                <div class="message-card" *ngFor="let msg of req.messages">
                    <div class="media" *ngIf="msg.type !== 'text'">
                        <span class="media-label">{{ getMediaLabel(msg) }}</span>
                        <img *ngIf="msg.type === 'image'" [src]="msg.thumbnailUrl" alt="support media">
                        <div class="video-thumb" *ngIf="msg.type === 'video'">
                            <img [src]="msg.thumbnailUrl" alt="video thumb">
                            <span class="play">â–¶</span>
                        </div>
                    </div>
                    <div class="message-body">
                        <p class="message-text">{{ msg.message }}</p>
                        <p class="from">From: {{ msg.anonymous ? 'Anonymous' : msg.fromName }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-section" *ngIf="req.mapMarkers?.length">
            <h3>Support From Around the World</h3>
            <p class="muted">See where messages of hope and encouragement have come from for this request</p>
            <div class="map-placeholder">
                Map view (mock) â€” markers: {{ req.mapMarkers?.length }}
            </div>
        </div>
    </div>
</div>

<ng-template #loadingTpl>
    <div class="loading">Loading request...</div>
</ng-template>
