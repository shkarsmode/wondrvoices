@if (!loading()) {
<div class="request-page">
    <div class="back-link">
        <a routerLink="/browse-requests">&larr; Back to Requests</a>
    </div>

    @if (request(); as req) {
    <div class="header-card">
        <div class="badge">
            <span class="material-symbols-outlined">favorite</span>
        </div>
        <div class="header-main">
            <div class="title-row">
                <h1>{{ getDisplayName() }}</h1>
            </div>
            <div class="meta-row">
                <span><span class="material-symbols-outlined">person</span> Age {{ req.age }}</span>
                <span><span class="material-symbols-outlined">location_on</span> {{ req.location }}</span>
                <span><span class="material-symbols-outlined">schedule</span> {{ getTimeAgo(req.createdAt) }}</span>
            </div>
            @if (req.hospital) {
                <div class="hospital">{{ req.hospital }}</div>
            }
            <div class="diagnosis-badge">{{ req.diagnosis }}</div>
            <p class="note">{{ req.additionalNote }}</p>
            <div class="tags">
                @for (zone of req.comfortZones; track zone) {
                    <span class="tag">
                        <span class="material-symbols-outlined">{{ getComfortZoneIcon(zone) }}</span> {{ zone | titlecase }}
                    </span>
                }
            </div>
            <div class="stats">
                <span [class.liked]="isLiked(req.id)"><span class="material-symbols-outlined" [class.liked]="isLiked(req.id)">favorite</span> {{ getHeartCount(req) }}</span>
                <span><span class="material-symbols-outlined">share</span> {{ req.shares || 0 }}</span>
                <span><span class="material-symbols-outlined">chat_bubble</span> {{ req.comments || 0 }}</span>
            </div>
        </div>
        <div class="cta">
            <div class="request-id">{{ req.id }}</div>
            <button class="btn-secondary" type="button" (click)="toggleSendLove()" [class.liked]="isLiked(req.id)">
                {{ isLiked(req.id) ? 'Love Sent' : 'Send Love' }}
            </button>
        </div>
    </div>

    <div class="support-section">
        <div class="feed-header">
            <div>
                <h2>Community Support Feed</h2>
                <p class="muted">See how the community is showing up for {{ getDisplayName() || 'them' }}</p>
            </div>
            <div class="message-count">{{ getSupportCount() }} messages</div>
        </div>

        <div class="tabs">
            <button class="tab active">
                <span class="material-symbols-outlined">favorite</span>
                Shared ({{ getSupportCount() }})
            </button>
            <button class="tab">
                <span class="material-symbols-outlined">pending</span>
                Pending (0)
            </button>
        </div>

        <div class="send-card" [class.open]="sendOpen()">
            <div class="send-header">
                <div class="title">Send your support to {{ getDisplayName() || 'them' }}</div>
                <div class="subtitle">Choose how you'd like to show you care</div>
            </div>
            <button type="button" class="send-field" (click)="toggleSend()">
                <div class="left">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <div class="text">
                        <div class="label">Send a message</div>
                        <div class="hint">Type or upload a photo/video</div>
                    </div>
                </div>
                <span class="material-symbols-outlined caret">{{ sendOpen() ? 'expand_less' : 'expand_more' }}</span>
            </button>

            @if (sendOpen()) {
            <div class="send-body">
                <form class="send-form">
                    <textarea rows="3" placeholder="Write your message of support for them..."></textarea>
                    <div class="inline-actions">
                        <button type="button" class="chip">
                            <span class="material-symbols-outlined">videocam</span>
                            Record video
                        </button>
                        <button type="button" class="chip">
                            <span class="material-symbols-outlined">upload_file</span>
                            Upload file
                        </button>
                    </div>
                    <input type="email" placeholder="Your email *">
                    <input type="text" placeholder="Your name (optional — leave blank to appear as 'Anonymous')">
                    <input type="text" placeholder="City you're sending from *">
                    <button type="button" class="btn-primary full">Send Message</button>
                </form>
            </div>
            }

            <div class="send-actions">
                <button type="button" class="ghost-btn">
                    <span class="material-symbols-outlined">smartphone</span>
                    Use App
                </button>
                <button type="button" class="ghost-btn" (click)="openMailModal()">
                    <span class="material-symbols-outlined">mail</span>
                    Mail a Card
                </button>
            </div>
        </div>

        <div class="feed-list">
            @for (msg of req.messages; track msg.id) {
                <div class="feed-card">
                    <div class="feed-card-header">
                        <div class="avatar">{{ getInitials(msg) }}</div>
                        <div class="meta">
                            <div class="name-row">
                                <span class="name">{{ msg.anonymous ? 'Anonymous' : msg.fromName }}</span>
                                <span class="pill">{{ getMessageTypeLabel(msg) }}</span>
                            </div>
                            <div class="meta-row">
                                @if (msg.location) {
                                    <span class="location">
                                        <span class="material-symbols-outlined">location_on</span> {{ msg.location }}
                                    </span>
                                    <span class="dot">&bull;</span>
                                }
                                <span class="time">{{ getTimeAgo(msg.createdAt) }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="feed-card-body">
                        @if (msg.type !== 'text' && msg.thumbnailUrl) {
                            <div class="media">
                                <img
                                    [alt]="getMessageTypeLabel(msg)"
                                    [src]="msg.thumbnailUrl"
                                    loading="lazy">
                                @if (msg.type === 'video') {
                                    <span class="media-badge">
                                        <span class="material-symbols-outlined">play_arrow</span>
                                    </span>
                                }
                            </div>
                        }
                        @if (msg.message) {
                            <p class="message-text">{{ msg.message }}</p>
                        }
                        @if (getPrimaryTag(req); as primaryTag) {
                            <div class="tags-row">
                                <span class="tag-pill">
                                    <span class="material-symbols-outlined">auto_awesome</span>
                                    {{ formatTag(primaryTag) }}
                                </span>
                            </div>
                        }
                    </div>

                    <div class="feed-card-footer">
                        <div class="stat">
                            <span class="material-symbols-outlined">favorite</span>
                            {{ msg.likes || 0 }}
                        </div>
                        <div class="stat share">
                            <span class="material-symbols-outlined">share</span>
                            Share
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (req.mapMarkers?.length) {
            <div class="map-section">
                <h3>Support From Around the World</h3>
                <p class="muted">See where messages of hope and encouragement have come from for this request</p>
                <div class="map-frame">
                    <div class="map-fake">
                        <div class="map-legend">
                            <span class="legend-dot primary"></span>
                            <span class="legend-label">Support markers</span>
                        </div>
                        <div class="map-placeholder">Map view ({{ req.mapMarkers?.length }} markers)</div>
                    </div>
                </div>
            </div>
        }
        @if (mailModalOpen()) {
        <div class="modal-backdrop">
            <div class="modal">
                <div class="modal-header">
                    <div class="title">
                        <span class="material-symbols-outlined">mail</span>
                        Mail a Physical Card
                    </div>
                    <button type="button" class="close" (click)="closeMailModal()">✕</button>
                </div>

                <p class="muted">Send a handwritten card or letter to brighten someone's day.</p>

                <div class="address-box">
                    <div class="address-label">Mail your card to:</div>
                    <div class="address-lines">
                        <div class="line">WondrVoices</div>
                        <div class="line">ID: {{ request()?.id }}</div>
                        <div class="line">PO Box 40056</div>
                        <div class="line">St. Pete, FL 33743</div>
                    </div>
                </div>

                <button type="button" class="btn-primary full" (click)="copyMailAddress()">
                    <span class="material-symbols-outlined">content_copy</span>
                    Copy Address
                </button>

                <p class="footnote">Important: Include the Request ID on your envelope so we can route it to the right person. Cards are reviewed by our moderation team before delivery.</p>
            </div>
        </div>
        }
    </div>
    }
</div>
}
@else {
<div class="loading">Loading request...</div>
}
