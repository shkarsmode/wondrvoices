@if (!loading()) {
<div class="request-page">
    <div class="back-link">
        <a routerLink="/browse-requests">← Back to Journeys</a>
    </div>

    @if (request(); as req) {
    <div class="header-card">
        <div class="card-top">
            <div class="badge-icon">
                <span class="material-symbols-outlined">favorite</span>
            </div>
            <div class="card-info">
                <div class="name-row">
                    <h1>{{ getDisplayName() }}</h1>
                    <span class="request-id">{{ req.id }}</span>
                </div>
                <div class="meta-row">
                    <span>{{ req.gender ? (req.gender | titlecase) + ', ' : '' }}Age {{ req.age }}</span>
                    <span class="dot">•</span>
                    <span>{{ req.location }}</span>
                    <span class="dot">•</span>
                    <span>{{ getTimeAgo(req.createdAt) }}</span>
                </div>
                @if (req.hospital) {
                <div class="hospital-row">
                    <span class="material-symbols-outlined">apartment</span>
                    <span>{{ req.hospital }}</span>
                </div>
                }
                <div class="diagnosis-badge">{{ req.diagnosis }}</div>
                <p class="note">{{ req.additionalNote }}</p>
                <div class="comfort-block">
                    <div class="comfort-label">What brings comfort:</div>
                    <div class="comfort-tags">
                        @for (zone of req.comfortZones; track zone) {
                        <span class="comfort-tag">
                            <span class="material-symbols-outlined">{{ getComfortZoneIcon(zone) }}</span>
                            {{ zone | titlecase }}
                        </span>
                        }
                    </div>
                </div>
                <div class="stats-row">
                    <span class="stat hearts" [class.liked]="isLiked(req.id)">
                        <span class="material-symbols-outlined">favorite</span>
                        {{ getHeartCount(req) }}
                    </span>
                    <span class="stat checks">
                        <span class="material-symbols-outlined">check_circle</span>
                        {{ req.comments || 0 }}
                    </span>
                    <span class="stat time">
                        <span class="material-symbols-outlined">schedule</span>
                        0
                    </span>
                </div>
            </div>
        </div>
        <div class="card-actions">
            <button class="btn-support" type="button" (click)="toggleSend()">
                <span class="material-symbols-outlined">favorite</span>
                Send Support
            </button>
            <button class="btn-share" type="button">
                <span class="material-symbols-outlined">ios_share</span>
                Share
            </button>
        </div>
    </div>

    <!-- Keep the Hope Flowing Banner -->
    <a class="keep-hope-banner" href="#FUNTHRZKBWU">
        <div class="banner-content">
            <div class="icon-wrap">
                <span class="material-symbols-outlined">eco</span>
            </div>
            <div class="text">
                <span class="title">Keep the hope flowing</span>
                <span class="subtitle">Your support helps more journeys get seen</span>
            </div>
        </div>
        <span class="material-symbols-outlined chevron">chevron_right</span>
    </a>

    <div class="support-section">
        <!-- <h3 class="section-title">Support their journey</h3>

        <div class="support-buttons">
            <button type="button" class="btn-use-app">
                <span class="material-symbols-outlined">smartphone</span>
                Use App
            </button>
            <button type="button" class="btn-mail-card">
                <span class="material-symbols-outlined">mail</span>
                Mail a Card
            </button>
        </div> -->

        <div class="send-card" [class.open]="sendOpen()">
            <button type="button" class="send-field" (click)="toggleSend()">
                <div class="left">
                    <span class="material-symbols-outlined">chat_bubble</span>
                    <div class="text">
                        <div class="label">Send a message</div>
                        <div class="hint">Type or upload a photo/video</div>
                    </div>
                </div>
                <span class="material-symbols-outlined caret">{{ sendOpen() ? 'expand_less' : 'expand_more' }}</span>
            </button>

            @if (sendOpen()) {
            <div class="send-body">
                <form class="send-form" (ngSubmit)="submitSupportMessage()">
                    <textarea
                        rows="4"
                        placeholder="Write your message of support..."
                        name="message"
                        [(ngModel)]="messageText"></textarea>
                    <div class="inline-actions">
                        <button type="button" class="chip" disabled>
                            <span class="material-symbols-outlined">videocam</span>
                            Record video
                        </button>
                        <button type="button" class="chip" (click)="fileInput.click()" [disabled]="uploadingMedia()">
                            <span class="material-symbols-outlined">upload</span>
                            Upload file
                        </button>
                        <input
                            #fileInput
                            type="file"
                            accept="image/*"
                            (change)="onFileSelected($event)"
                            hidden>
                    </div>
                    @if (uploadedMediaUrl()) {
                        <div class="media-preview">
                            <img [src]="uploadedMediaUrl()" alt="Uploaded image" loading="lazy">
                        </div>
                    }
                    <input
                        type="email"
                        placeholder="Your email *"
                        name="email"
                        required
                        [(ngModel)]="senderEmail">
                    <input
                        type="text"
                        placeholder="Your name (optional — leave blank to appear as 'Anonymous')"
                        name="name"
                        [(ngModel)]="senderName">
                    <p class="hint-text">e.g. "Sarah from Seattle" or just "Anonymous from Seattle"</p>
                    <input
                        type="text"
                        placeholder="City you're sending from *"
                        name="location"
                        required
                        [(ngModel)]="senderLocation">
                    <button type="submit" class="btn-send" [disabled]="sendingMessage() || uploadingMedia()">
                        <span class="material-symbols-outlined">send</span>
                        Send Message
                    </button>
                </form>
            </div>
            }
        </div>

        <div class="feed-header">
            <div>
                <h3>Support From Around the World</h3>
                <p class="muted">where messages of hope and encouragement have come from for this request</p>
            </div>
        </div>

        <div class="feed-list">
            @for (msg of req.messages; track msg.id) {
                <div class="feed-card">
                    <div class="feed-card-header">
                        <div class="avatar">{{ getInitials(msg) }}</div>
                        <div class="meta">
                            <div class="name-row">
                                <span class="name">{{ msg.anonymous ? 'Anonymous' : msg.fromName }}</span>
                            </div>
                            <div class="meta-row">
                                @if (msg.location) {
                                    <span class="material-symbols-outlined">location_on</span>
                                    <span>{{ msg.location }}</span>
                                    <span class="dot">•</span>
                                }
                                <span class="material-symbols-outlined">schedule</span>
                                <span>{{ getTimeAgo(msg.createdAt) }}</span>
                            </div>
                        </div>
                        <button class="share-btn" type="button">
                            <span class="material-symbols-outlined">ios_share</span>
                        </button>
                    </div>

                    <div class="feed-card-body">
                        @if (msg.message) {
                            <p class="message-text">"{{ msg.message }}"</p>
                        }
                        @if (msg.type !== 'text' && msg.thumbnailUrl) {
                            <div class="media">
                                <img
                                    [alt]="getMessageTypeLabel(msg)"
                                    [src]="msg.thumbnailUrl"
                                    loading="lazy">
                                @if (msg.type === 'video') {
                                    <span class="media-badge">
                                        <span class="material-symbols-outlined">play_arrow</span>
                                    </span>
                                }
                            </div>
                        }
                        @if (getPrimaryTag(req); as primaryTag) {
                            <div class="tags-row">
                                <span class="tag-pill">
                                    <span class="material-symbols-outlined">auto_awesome</span>
                                    {{ formatTag(primaryTag) }}
                                </span>
                            </div>
                        }
                    </div>

                    <div class="feed-card-footer">
                        <div class="stat hearts">
                            <span class="material-symbols-outlined">favorite</span>
                            {{ msg.likes || 0 }}
                        </div>
                        <button class="stat share-link" type="button">
                            <span class="material-symbols-outlined">ios_share</span>
                            Share
                        </button>
                    </div>
                </div>
            }
        </div>

        <div class="map-section">
            <h3>Support From Around the World</h3>
            <p class="muted">where messages of hope and encouragement have come from for this request</p>
            @if (req.mapMarkers?.length) {
            <div class="map-frame">
                <div class="map-fake">
                    <div class="map-legend">
                        <span class="legend-dot primary"></span>
                        <span class="legend-label">Support markers</span>
                    </div>
                    <div class="map-placeholder">Map view ({{ req.mapMarkers?.length }} markers)</div>
                </div>
            </div>
            }
        </div>
        @if (mailModalOpen()) {
        <div class="modal-backdrop">
            <div class="modal">
                <div class="modal-header">
                    <div class="title">
                        <span class="material-symbols-outlined">mail</span>
                        Mail a Physical Card
                    </div>
                    <button type="button" class="close" (click)="closeMailModal()">✕</button>
                </div>

                <p class="muted">Send a handwritten card or letter to brighten someone's day.</p>

                <div class="address-box">
                    <div class="address-label">Mail your card to:</div>
                    <div class="address-lines">
                        <div class="line">WondrVoices</div>
                        <div class="line">ID: {{ request()?.id }}</div>
                        <div class="line">PO Box 40056</div>
                        <div class="line">St. Pete, FL 33743</div>
                    </div>
                </div>

                <button type="button" class="btn-primary full" (click)="copyMailAddress()">
                    <span class="material-symbols-outlined">content_copy</span>
                    Copy Address
                </button>

                <p class="footnote">Important: Include the Request ID on your envelope so we can route it to the right person. Cards are reviewed by our moderation team before delivery.</p>
            </div>
        </div>
        }
    </div>
    }
</div>
}
@else {
<div class="loading">Loading request...</div>
}
